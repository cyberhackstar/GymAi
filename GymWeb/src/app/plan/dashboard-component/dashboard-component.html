<div class="dashboard-container">
  <!-- User Form Section -->
  <div class="user-form-section" *ngIf="showUserForm">
    <div class="form-card">
      <div class="form-header">
        <h2>Create Your <span>Fitness Plan</span></h2>
        <p>
          Tell us about yourself to get a personalized fitness and nutrition
          plan
        </p>
      </div>
      <form (ngSubmit)="onSubmit()" class="fitness-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input
              type="text"
              id="name"
              [(ngModel)]="userProfile.name"
              name="name"
              required
            />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              [(ngModel)]="userProfile.email"
              name="email"
              required
            />
          </div>
          <div class="form-group">
            <label for="age">Age</label>
            <input
              type="number"
              id="age"
              [(ngModel)]="userProfile.age"
              name="age"
              min="16"
              max="80"
              required
            />
          </div>
          <div class="form-group">
            <label for="height">Height (cm)</label>
            <input
              type="number"
              id="height"
              [(ngModel)]="userProfile.height"
              name="height"
              min="100"
              max="250"
              required
            />
          </div>
          <div class="form-group">
            <label for="weight">Weight (kg)</label>
            <input
              type="number"
              id="weight"
              [(ngModel)]="userProfile.weight"
              name="weight"
              min="30"
              max="200"
              required
            />
          </div>
          <div class="form-group">
            <label for="gender">Gender</label>
            <select
              id="gender"
              [(ngModel)]="userProfile.gender"
              name="gender"
              required
            >
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label for="goal">Fitness Goal</label>
            <select
              id="goal"
              [(ngModel)]="userProfile.goal"
              name="goal"
              required
            >
              <option value="WEIGHT_LOSS">Weight Loss</option>
              <option value="WEIGHT_GAIN">Weight Gain</option>
              <option value="MUSCLE_GAIN">Muscle Gain</option>
              <option value="MAINTENANCE">Maintenance</option>
            </select>
          </div>
          <div class="form-group">
            <label for="activityLevel">Activity Level</label>
            <select
              id="activityLevel"
              [(ngModel)]="userProfile.activityLevel"
              name="activityLevel"
              required
            >
              <option value="SEDENTARY">Sedentary (Desk job)</option>
              <option value="LIGHTLY_ACTIVE">
                Lightly Active (1-3 days/week)
              </option>
              <option value="MODERATELY_ACTIVE">
                Moderately Active (3-5 days/week)
              </option>
              <option value="VERY_ACTIVE">Very Active (6-7 days/week)</option>
              <option value="EXTREMELY_ACTIVE">
                Extremely Active (2x/day)
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="preference">Diet Preference</label>
            <select
              id="preference"
              [(ngModel)]="userProfile.preference"
              name="preference"
              required
            >
              <option value="VEG">Vegetarian</option>
              <option value="NON_VEG">Non-Vegetarian</option>
              <option value="VEGAN">Vegan</option>
            </select>
          </div>
        </div>
        <button type="submit" class="generate-btn" [disabled]="isLoading">
          <i class="fas fa-magic" *ngIf="!isLoading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
          {{
            isLoading
              ? "Generating..."
              : isProfileComplete
              ? "Update Plan"
              : "Generate Plan"
          }}
        </button>
      </form>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-content" *ngIf="!showUserForm && plansExist">
    <!-- Header Stats -->
    <div class="stats-header">
      <div class="user-welcome">
        <h1>
          Welcome back, <span>{{ userProfile.name }}</span>
        </h1>
        <p>{{ plansResponse?.summary }}</p>
      </div>
      <div class="quick-actions">
        <button class="action-btn" (click)="editProfile()">
          <i class="fas fa-user-edit"></i>
          Edit Profile
        </button>
        <button class="action-btn danger" (click)="clearData()">
          <i class="fas fa-trash"></i>
          Clear Data
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-fire"></i></div>
        <div class="stat-content">
          <h3>
            {{
              dailyCalorieTarget !== null
                ? (dailyCalorieTarget | number : "1.0-0")
                : "--"
            }}
          </h3>
          <p>Daily Calories</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-dumbbell"></i></div>
        <div class="stat-content">
          <h3>{{ getWeeklyWorkouts() }}</h3>
          <p>Workouts/Week</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
        <div class="stat-content">
          <h3>{{ getBMI() }}</h3>
          <p>BMI ({{ getBMIStatus() }})</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-bolt"></i></div>
        <div class="stat-content">
          <h3>{{ getAverageCaloriesBurned() }}</h3>
          <p>Avg. Calories Burned</p>
        </div>
      </div>
    </div>

    <!-- Progress Charts -->
    <div class="charts-grid">
      <!-- Calorie Tracking Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Weekly Calorie Progress</h3>
          <span class="chart-subtitle">
            Target:
            {{
              dailyCalorieTarget !== null
                ? (dailyCalorieTarget | number : "1.0-0")
                : "--"
            }}
            kcal/day
          </span>
        </div>
        <div class="chart-content">
          <div class="chart-bar-container">
            <div
              class="chart-bars"
              *ngFor="let calorie of chartData.calories; let i = index"
            >
              <div class="bar-wrapper">
                <div
                  class="bar"
                  [style.height.%]="(calorie / 3200) * 100"
                  [class.target-met]="
                    dailyCalorieTarget !== null && calorie >= dailyCalorieTarget
                  "
                ></div>
                <span class="bar-label">{{ weekDays[i] }}</span>
                <span class="bar-value">{{ calorie }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Protein Tracking Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Protein Intake Progress</h3>
          <span class="chart-subtitle">
            Target:
            {{
              dailyProteinTarget !== null
                ? (dailyProteinTarget | number : "1.0-0")
                : "--"
            }}g/day
          </span>
        </div>
        <div class="chart-content">
          <div class="chart-bar-container">
            <div
              class="chart-bars"
              *ngFor="let protein of chartData.protein; let i = index"
            >
              <div class="bar-wrapper">
                <div
                  class="bar protein-bar"
                  [style.height.%]="(protein / 250) * 100"
                  [class.target-met]="
                    dailyProteinTarget !== null && protein >= dailyProteinTarget
                  "
                ></div>
                <span class="bar-label">{{ weekDays[i] }}</span>
                <span class="bar-value">{{ protein }}g</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Workout Completion Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Workout Completion</h3>
          <span class="chart-subtitle">Weekly Overview</span>
        </div>
        <div class="chart-content">
          <div class="workout-grid">
            <div
              class="workout-day"
              *ngFor="let workout of chartData.workouts; let i = index"
            >
              <div
                class="workout-indicator"
                [class.completed]="workout === 1"
                [class.rest]="
                  weeklyPlan && weeklyPlan[i] && weeklyPlan[i].restDay
                "
              >
                <i
                  class="fas"
                  [class.fa-check]="workout === 1"
                  [class.fa-times]="
                    workout === 0 &&
                    weeklyPlan &&
                    weeklyPlan[i] &&
                    !weeklyPlan[i].restDay
                  "
                  [class.fa-bed]="
                    weeklyPlan && weeklyPlan[i] && weeklyPlan[i].restDay
                  "
                ></i>
              </div>
              <span class="workout-day-label">{{ weekDays[i] }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nutrition Overview -->
    <div class="nutrition-overview" *ngIf="nutrition">
      <h3>Nutrition Analysis</h3>
      <div class="nutrition-grid">
        <div class="nutrition-item">
          <div class="nutrition-circle">
            <div class="circle-progress calories-progress">
              <span>{{ nutrition.bmr | number : "1.0-0" }}</span>
            </div>
          </div>
          <h4>BMR</h4>
          <p>Basal Metabolic Rate</p>
        </div>
        <div class="nutrition-item">
          <div class="nutrition-circle">
            <div class="circle-progress tdee-progress">
              <span>{{ nutrition.tdee | number : "1.0-0" }}</span>
            </div>
          </div>
          <h4>TDEE</h4>
          <p>Total Daily Energy</p>
        </div>
        <div class="nutrition-item">
          <div class="nutrition-circle">
            <div class="circle-progress protein-progress">
              <span>{{ nutrition.dailyProtein | number : "1.0-0" }}g</span>
            </div>
          </div>
          <h4>Protein</h4>
          <p>Daily Target</p>
        </div>
        <div class="nutrition-item">
          <div class="nutrition-circle">
            <div class="circle-progress carbs-progress">
              <span>{{ nutrition.dailyCarbs | number : "1.0-0" }}g</span>
            </div>
          </div>
          <h4>Carbs</h4>
          <p>Daily Target</p>
        </div>
      </div>
    </div>

    <!-- Today's Plan Quick View -->
    <div class="today-plan" *ngIf="plansResponse">
      <h3>Today's Plan Overview</h3>
      <div class="today-grid">
        <!-- Today's Meals -->
        <div class="today-section">
          <h4><i class="fas fa-utensils"></i> Today's Meals</h4>
          <div class="meal-preview" *ngFor="let meal of getTodaysMeals()">
            <div class="meal-info">
              <span class="meal-type">{{ meal.mealType }}</span>
              <span class="meal-calories"
                >{{ meal.totalCalories | number : "1.0-0" }} kcal</span
              >
            </div>
            <div class="meal-items">
              <span *ngFor="let item of meal.foodItems; let last = last">
                {{ item.foodName }}{{ !last ? "," : "" }}
              </span>
            </div>
          </div>
        </div>

        <!-- Today's Workout -->
        <div class="today-section">
          <h4><i class="fas fa-dumbbell"></i> Today's Workout</h4>
          <div class="workout-preview" *ngIf="getTodaysWorkout()">
            <div class="workout-info">
              <span class="workout-focus">{{
                getTodaysWorkout()?.focusArea | titlecase
              }}</span>
              <span class="workout-duration"
                >{{ getTodaysWorkout()?.estimatedDurationMinutes }} min</span
              >
            </div>
            <div class="exercise-list">
              <div
                class="exercise-item"
                *ngFor="let ex of getTodaysWorkoutExercises()"
              >
                {{ ex.exerciseName }} - {{ ex.sets }}x{{
                  ex.reps || ex.durationMinutes + "min"
                }}
              </div>
              <div
                class="more-exercises"
                *ngIf="getTodaysWorkoutExercisesCount() > 3"
              >
                +{{ getTodaysWorkoutExercisesCount() - 3 }} more exercises
              </div>
            </div>
          </div>
          <div class="rest-day" *ngIf="isTodayRestDay()">
            <i class="fas fa-bed"></i>
            <p>Rest Day - Recovery Time</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons" *ngIf="plansResponse">
      <button class="primary-btn diet-btn" routerLink="/diet">
        <i class="fas fa-utensils"></i>
        View Diet Plan
      </button>
      <button class="primary-btn workout-btn" routerLink="/workout">
        <i class="fas fa-dumbbell"></i>
        View Workout Plan
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <app-loading-spinner message="Generating your diet and workout...">
    </app-loading-spinner>
  </div>
</div>
