<div class="diet-container">
  <h2 class="diet-heading">üçΩÔ∏è Diet & Meals Plan</h2>

  <!-- Always show first day -->
  <div *ngIf="dietPlan.length" class="day-card">
    <ng-container
      *ngTemplateOutlet="dayTemplate; context: { $implicit: dietPlan }"
    ></ng-container>
  </div>

  <!-- Show other days if expanded -->
  <div *ngIf="showAllDays">
    <div *ngFor="let dayPlan of dietPlan.slice(1)" class="day-card">
      <ng-container
        *ngTemplateOutlet="dayTemplate; context: { $implicit: dayPlan }"
      ></ng-container>
    </div>
  </div>

  <!-- Expand / Collapse button -->
  <div class="expand-btn-container">
    <button class="expand-btn" (click)="toggleDays()">
      {{ showAllDays ? "Collapse Days ‚ñ≤" : "Expand Days ‚ñº" }}
    </button>
  </div>

  <!-- Template for one day's content -->
  <ng-template #dayTemplate let-dayPlan>
    <h3 class="day-title">{{ dayPlan.day }}</h3>

    <div class="progress-container">
      <p class="calorie-text">
        {{ dayPlan.dailyCaloriesTaken }} /
        {{ dayPlan.total_daily_calories }} kcal ({{ dayPlan.progressPercent }}%)
      </p>
      <div class="progress-bar">
        <div
          class="progress"
          [style.width.%]="dayPlan.progressPercent"
          [style.backgroundColor]="dayPlan.progressColor"
        ></div>
      </div>
    </div>

    <!-- Desktop table -->
    <div class="meal-table-wrapper desktop-view">
      <table class="meal-table">
        <thead>
          <tr>
            <th>‚úì</th>
            <th>Time</th>
            <th>Meal Type</th>
            <th>Food</th>
            <th>Quantity (g)</th>
            <th>Protein (g)</th>
            <th>Carbs (g)</th>
            <th>Fat (g)</th>
            <th>Fiber (g)</th>
            <th>Calories</th>
            <th>Image</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let meal of dayPlan.meals; let i = index">
            <tr>
              <td colspan="11" class="meal-heading">{{ meal.meal_type }}</td>
            </tr>
            <tr *ngFor="let food of meal.food_items">
              <td>
                <input
                  type="checkbox"
                  [(ngModel)]="food.taken"
                  (change)="updateCalories(); updateDailyProgress(dayPlan)"
                />
              </td>
              <td>{{ getMealTime(meal.meal_type, i) }}</td>
              <td>{{ meal.meal_type }}</td>
              <td>{{ food.name }}</td>
              <td>{{ food.quantity | number : "1.0-0" }}</td>
              <td>{{ food.protein | number : "1.1-2" }}</td>
              <td>{{ food.carbs | number : "1.1-2" }}</td>
              <td>{{ food.fat | number : "1.1-2" }}</td>
              <td>{{ food.fiber | number : "1.1-2" }}</td>
              <td>{{ food.calories | number : "1.1-2" }}</td>
              <td>
                <img
                  [src]="food.image"
                  alt="{{ food.name }}"
                  class="table-meal-image"
                  (click)="openLightbox(food.image)"
                />
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Mobile swipe carousel -->
    <div
      class="mobile-view swipe-container"
      (swipeleft)="nextMeal(dayPlan)"
      (swiperight)="prevMeal(dayPlan)"
    >
      <div
        class="meals-wrapper"
        [style.transform]="
          'translateX(-' + dayPlan.activeMealIndex * 100 + '%)'
        "
      >
        <div
          class="meal-card"
          *ngFor="let meal of dayPlan.meals; let i = index"
        >
          <div class="meal-content-wrapper">
            <div class="meal-details">
              <div class="meal-header">
                <span class="meal-time">{{
                  getMealTime(meal.meal_type, i)
                }}</span>
              </div>
              <h4 class="meal-name">{{ meal.meal_type }}</h4>

              <div class="meal-nutrients" *ngFor="let food of meal.food_items">
                <input
                  type="checkbox"
                  [(ngModel)]="food.taken"
                  (change)="updateCalories(); updateDailyProgress(dayPlan)"
                />
                <p>
                  <strong>{{ food.name }}</strong>
                  <span>({{ food.quantity | number : "1.0-0" }}g)</span>
                </p>
                <p>Protein: {{ food.protein | number : "1.1-2" }} g</p>
                <p>Carbs: {{ food.carbs | number : "1.1-2" }} g</p>
                <p>Fat: {{ food.fat | number : "1.1-2" }} g</p>
                <p>Fiber: {{ food.fiber | number : "1.1-2" }} g</p>
                <p>Calories: {{ food.calories | number : "1.1-2" }}</p>
              </div>
            </div>
            <div class="meal-image" *ngIf="meal.food_items.length">
              <img
                [src]="meal.food_items.image"
                alt="{{ meal.food_items.name }}"
                (click)="openLightbox(meal.food_items.image)"
              />
              <span class="meal-time-badge">{{
                getMealTime(meal.meal_type, i)
              }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Pagination dots -->
      <div class="dots-container">
        <span
          *ngFor="let meal of dayPlan.meals; let idx = index"
          class="dot"
          [class.active-dot]="idx === dayPlan.activeMealIndex"
          (click)="goToMeal(dayPlan, idx)"
        ></span>
      </div>
    </div>
  </ng-template>

  <!-- Lightbox for images -->
  <div class="lightbox" *ngIf="lightboxImage" (click)="closeLightbox()">
    <img [src]="lightboxImage" alt="Meal" class="lightbox-img" />
  </div>
</div>
